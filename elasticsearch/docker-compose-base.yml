version: "2.1"

services:
  elasticsearch-base:
    image: amazon/opendistro-for-elasticsearch:0.9.0
    # this is private to the cluster, only open for debugging
    # ports:
    #   - "9200:9200"
    environment:
      discovery.type: single-node
      opendistro_security.ssl.http.enabled: "false"

  kibana-base:
    image: amazon/opendistro-for-elasticsearch-kibana:0.9.0
    # this is private to the cluster, only open for debugging
    # ports:
    #   - "5601:5601"
    environment:
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ELASTICSEARCH_PRESERVEHOST: "false"
      SERVER_BASEPATH: "/kibana-app"
      SERVER_REWRITEBASEPATH: "true"
      opendistro_security.ssl.http.enabled: "false"
    volumes:
      - ./conf/security.yml:/usr/share/kibana/plugins/opendistro_security/securityconfig/config.yml
      - ./conf/kibana.yml:/usr/share/kibana/config/kibana.yml

  es-consumer-base:
    # demo version without job handling!
    image: ehealthafrica/aether-elasticsearch-consumer:alpha-20190625-01
    stdin_open: true
    # ports:
    #   - "9009:9009"
    volumes:
     - ./conf:/code/conf/consumer
     - ./es_index:/code/es_index

    environment:
      PYTHONUNBUFFERED: 0
      KAFKA_URL: kafka:29092
      SECURITY_PROTOCOL: SASL_PLAINTEXT
      SASL_MECHANISM: PLAIN
      SASL_PLAIN_USERNAME: ${KAFKA_ROOT_USER}
      SASL_PLAIN_PASSWORD: ${KAFKA_ROOT_PASSWORD}
      KIBANA_URL: http://kibana:5601
      ELASTICSEARCH_URL: elasticsearch
      ELASTICSEARCH_PORT: 9200
      ELASTICSEARCH_USER: admin
      ELASTICSEARCH_PASSWORD: ${ELASTICSEARCH_PASSWORD}
      LOG_LEVEL: ERROR
      CONSUMER_PORT: 9099
      ES_CONSUMER_CONFIG_PATH: /code/conf/consumer/consumer.json
      ES_CONSUMER_KAFKA_CONFIG_PATH: /code/conf/consumer/kafka.json
    command: start
