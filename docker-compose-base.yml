version: "2.1"

services:

  # ---------------------------------
  # Database
  # ---------------------------------

  postgres-base:
    image: postgres:9.6-alpine
    volumes:
      # data volume
      - ./.persistent_data/db/data:/var/lib/postgresql/data


  # ---------------------------------
  # NGINX
  # ---------------------------------

  nginx-base:
    image: nginx:stable-alpine
    volumes:
      # config file
      - ./scripts/conf/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./scripts/conf/nginx/sites-enabled:/etc/nginx/sites-enabled

      # nginx log files
      - ./.persistent_data/nginx:/var/log/nginx/

      # aether favicon
      - ./assets/aether.ico:/media/eather.ico

      # media folders per container
      - ./.persistent_data/kernel/media:/media/kernel
      - ./.persistent_data/odk/media:/media/odk

      # static folders per container
      - ./.persistent_data/kernel/static:/static/kernel
      - ./.persistent_data/odk/static:/static/odk
      - ./.persistent_data/ui/static:/static/ui

    ports:
      # "HOST:CONTAINER"
      - "80:80"
      - "8443:8443"


  # ---------------------------------
  # Aether kernel
  # ---------------------------------

  kernel-base:
    image: ehealthafrica/aether-kernel:0.8.0
    environment:
      CSRF_COOKIE_DOMAIN: .aether.local
      HOSTNAME: kernel.aether.local

      # DEBUG: "true"
      DJANGO_SECRET_KEY: "T7cyDESETLHDz43xf3Spx9NN6UdbDkpeREfy6fwATcckcwXUUvnqfHcwyNLHrXAZ"

      # mandatory with "start" command
      ADMIN_PASSWORD: "adminadmin"
      AETHER_KERNEL_TOKEN: a2d6bc20ad16ec8e715f2f42f54eb00cbbea2d24

      RDS_DB_NAME: aether
      RDS_HOSTNAME: db
      RDS_PASSWORD: ""
      RDS_PORT: 5432
      RDS_USERNAME: postgres

      WEB_SERVER_PORT: 8000
    volumes:
      # media folder used by nginx
      - ./.persistent_data/kernel/media:/media
      # static folder used by nginx
      - ./.persistent_data/kernel/static:/var/www/static
      # uwsgi.ini using port 8000
      - ./scripts/conf/uwsgi/kernel.ini:/code/conf/uwsgi.ini
    ports:
      # "HOST:CONTAINER"
      - "8000:8000"
    command: start


  # ---------------------------------
  # ODK Module
  # ---------------------------------

  odk-base:
    image: ehealthafrica/aether-odk:0.8.0
    environment:
      CSRF_COOKIE_DOMAIN: .aether.local
      HOSTNAME: odk.aether.local

      # DEBUG: "true"
      DJANGO_SECRET_KEY: "T7cyDESETLHDz43xf3Spx9NN6UdbDkpeREfy6fwATcckcwXUUvnqfHcwyNLHrXAZ"

      # mandatory with "start" command
      ADMIN_PASSWORD: "adminadmin"
      AETHER_ODK_TOKEN: a2d6bc20ad16ec8e715f2f42f54eb00cbbea2d24

      AETHER_KERNEL_TOKEN: a2d6bc20ad16ec8e715f2f42f54eb00cbbea2d24
      AETHER_KERNEL_URL: http://kernel:8000
      AETHER_KERNEL_URL_TEST: http://kernel-test:9001

      RDS_DB_NAME: aether-odk
      RDS_HOSTNAME: db
      RDS_PASSWORD: ""
      RDS_PORT: 5432
      RDS_USERNAME: postgres

      WEB_SERVER_PORT: 8002
    volumes:
      # media folder used by nginx
      - ./.persistent_data/odk/media:/media
      # static folder used by nginx
      - ./.persistent_data/odk/static:/var/www/static
      # uwsgi.ini using port 8443
      - ./scripts/conf/uwsgi/odk.ini:/code/conf/uwsgi.ini
    ports:
      - "8002:8002"
    command: start


  # ---------------------------------
  # Aether UI module
  # ---------------------------------

  ui-base:
    image: ehealthafrica/aether-ui:0.8.0
    environment: &ui-environment
      CSRF_COOKIE_DOMAIN: .aether.local
      HOSTNAME: ui.aether.local

      # DEBUG: "true"
      DJANGO_SECRET_KEY: "T7cyDESETLHDz43xf3Spx9NN6UdbDkpeREfy6fwATcckcwXUUvnqfHcwyNLHrXAZ"

      # mandatory with "start" command
      ADMIN_PASSWORD: "adminadmin"

      AETHER_KERNEL_TOKEN: a2d6bc20ad16ec8e715f2f42f54eb00cbbea2d24
      AETHER_KERNEL_URL: http://kernel:8000
      AETHER_KERNEL_URL_TEST: http://kernel-test:9001

      RDS_DB_NAME: aether-ui
      RDS_HOSTNAME: db
      RDS_PASSWORD: ""
      RDS_PORT: 5432
      RDS_USERNAME: postgres

      WEB_SERVER_PORT: 8004
    volumes:
      # static folder used by nginx
      - ./.persistent_data/ui/static:/var/www/static
      # uwsgi.ini using port 8004
      - ./scripts/conf/uwsgi/ui.ini:/code/conf/uwsgi.ini
    ports:
      - "8004:8004"
    command: start


  # ---------------------------------
  # Kafka & Zookeeper
  # ---------------------------------

  zookeeper-base:
    image: confluentinc/cp-zookeeper:latest
    restart: on-failure
    environment:
      ZOOKEEPER_CLIENT_PORT: 32181
      ZOOKEEPER_TICK_TIME: 2000
    extra_hosts:
      - "moby:127.0.0.1"

  kafka-base:
    image: confluentinc/cp-kafka:latest
    restart: on-failure
    ports:
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:32181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_LOG_RETENTION_HOURS: -1
      ADVERTISED_HOST_NAME: kafka

    extra_hosts:
      - "moby:127.0.0.1"


  # ---------------------------------
  # Aether Kafka Producer
  # ---------------------------------

  aether-producer-base:
    image: ehealthafrica/aether-producer:0.8.0
    restart: on-failure
    stdin_open: true
    environment:
     - PYTHONUNBUFFERED=1
    command: start_dev
